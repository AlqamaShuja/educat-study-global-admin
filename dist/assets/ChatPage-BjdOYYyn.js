import{r as d,j as e,y as N,s as k,b as Y}from"./index-B8d-T4_g.js";import{a as j}from"./messageService-BIb6aoiZ.js";import{M as K,S as G}from"./send-Bn6WymOb.js";import{S as J}from"./search-v1ZxCjqm.js";import{U as V}from"./user-B-VtmG-j.js";import{g as T}from"./helpers-BSP2OzYC.js";import{c as Q}from"./createLucideIcon-Sm81qEul.js";import{L as O}from"./loader-kdRCyvKb.js";/**
 * @license lucide-react v0.516.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],$=Q("paperclip",W);/**
 * @license lucide-react v0.516.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Z=Q("reply",X),C=({user:r,conversations:g,setConversations:w,selectedConversation:s,setSelectedConversation:H,setMessages:A,allowedRecipients:b,setAllowedRecipients:v})=>{const[I,F]=d.useState(null),[S,y]=d.useState({}),[x,L]=d.useState("");d.useEffect(()=>{const t=async()=>{try{const n=await j.getConversations();w(n.data)}catch{N.error("Failed to load conversations")}},l=async()=>{try{const n=await j.getAllowedRecipients();v(n.data)}catch{N.error("Failed to load recipients")}},c=async()=>{try{const p=(await j.getUnreadMessageCount()).data.reduce((m,{conversationHash:z,unreadCount:_})=>({...m,[z]:_}),{});y(p)}catch{N.error("Failed to load unread message counts")}};if(r&&r.id)return(r==null?void 0:r.role)==="super_admin"&&t(),l(),c(),k.onNewMessage(n=>{if(console.log(n,"ascsancjanjsncsajs",r),n.senderId===r.id||n.recipientId===r.id)console.log(n.recipientId===r.id&&(s==null?void 0:s.conversationHash)!==n.conversationHash,"sacnascjascnanasnacs"),n.recipientId===r.id&&(s==null?void 0:s.conversationHash)!==n.conversationHash&&y(p=>({...p,[n.conversationHash]:(p[n.conversationHash]||0)+1}));else if(r.role==="super_admin"){const p=b.map(m=>m.id);(n.conversationHash.includes(r.id)||p.includes(n.senderId)||p.includes(n.recipientId))&&(s==null?void 0:s.conversationHash)!==n.conversationHash&&y(m=>({...m,[n.conversationHash]:(m[n.conversationHash]||0)+1}))}}),k.onMessageRead(n=>{n.recipientId===r.id&&c()}),()=>{k.onNewMessage(null),k.onMessageRead(null)}},[r]),d.useEffect(()=>{if((s==null?void 0:s.type)!=="recipient")return;const t=[s.id,r==null?void 0:r.id].sort().join("_"),l=async()=>{try{const n=await j.markConversationMessagesAsRead(t);console.log(n,"sacsancsjacnsascn"),y(p=>({...p,[t]:0}))}catch(n){console.error("Failed to mark as read",n)}};l();const c=setInterval(l,3e4);return()=>clearInterval(c)},[s,r==null?void 0:r.id]);const E=async t=>{var l,c;if(console.log(t,"sanasjcasjcasjcns"),H(t),F(t.id),A([]),t.type==="conversation"){const n=t.conversationHash;try{const p=t==null?void 0:t.conversationHash;y(m=>({...m,[n]:0}))}catch(p){N.error(((c=(l=p.response)==null?void 0:l.data)==null?void 0:c.message)||"Failed to load messages")}}else{const n=`${[t==null?void 0:t.id,r==null?void 0:r.id].sort().join("_")}`,p=await j.markConversationMessagesAsRead(n);console.log(p,"sacsancsjacnsascn"),y(m=>({...m,[n]:0}))}},D=[...g.map(t=>({...t,type:"conversation",id:t.conversationHash})),...b.filter(t=>t.id!==r.id&&!g.some(l=>l.conversationHash.includes(t.id)&&l.conversationHash.includes(r.id))).map(t=>({id:t.id,displayName:t.name,type:"recipient",recipient:t}))].sort((t,l)=>{const c=t.lastMessage?new Date(t.lastMessage.createdAt):new Date(0);return(l.lastMessage?new Date(l.lastMessage.createdAt):new Date(0))-c});console.log(D,"ascakcnasnsacnasnca",g);const R=D.filter(t=>t.displayName.toLowerCase().includes(x.toLowerCase())),M=t=>{var c,n;if(console.log(t,"acnajsnasncjsanc"),t.recipient&&((c=t.recipient)!=null&&c.role))return(n=t.recipient)==null?void 0:n.role;if(!t.lastMessage)return"No messages yet";const l=t.lastMessage.content;return l.length>40?l.substring(0,40)+"...":l},U=t=>{if(!t)return"";const l=new Date(t),n=(new Date-l)/(1e3*60*60);return n<24?l.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):n<168?l.toLocaleDateString("en-US",{weekday:"short"}):l.toLocaleDateString("en-US",{month:"short",day:"numeric"})};return e.jsxs("div",{className:"w-80 bg-white shadow-2xl rounded-l-2xl border border-gray-200/50 flex flex-col",children:[e.jsxs("div",{className:"px-6 py-4 bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 text-white rounded-tl-2xl",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm",children:e.jsx(K,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Messages"}),e.jsxs("p",{className:"text-sm text-white/80",children:[R.length," conversations"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(J,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-white/60"}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:x,onChange:t=>L(t.target.value),className:"w-full pl-10 pr-4 py-2 bg-white/20 backdrop-blur-sm border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-200"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:R.length===0?e.jsxs("div",{className:"p-6 text-center text-gray-500",children:[e.jsx(K,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:x?"No conversations found":"No conversations yet"})]}):R.map(t=>{const l=`${[t==null?void 0:t.id,r==null?void 0:r.id].sort().join("_")}`,c=S[l]||0;return e.jsx("div",{onClick:()=>E(t),className:`p-4 cursor-pointer border-b border-gray-100/50 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200 ${I===t.id?"bg-gradient-to-r from-blue-100 to-indigo-100 border-l-4 border-l-blue-500":""}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:`relative flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold text-sm ${t.type==="recipient"?"bg-gradient-to-br from-green-500 to-emerald-600":"bg-gradient-to-br from-purple-500 to-pink-600"}`,children:[t.type==="recipient"&&e.jsx(V,{className:"w-5 h-5"}),t.type==="conversation"&&t.displayName.charAt(0).toUpperCase()]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:"font-semibold text-gray-800 truncate text-sm",children:t.displayName}),e.jsxs("div",{className:"flex items-center gap-2",children:[t.lastMessage&&e.jsx("span",{className:"text-xs text-gray-500",children:U(t.lastMessage.createdAt)}),c>0&&e.jsx("span",{className:"bg-gradient-to-r from-red-500 to-pink-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-sm",children:c>99?"99+":c})]})]}),e.jsx("p",{className:"text-sm text-gray-500 truncate",children:M(t)})]})]})},t.id)})})]})},ee=({user:r,messages:g,setMessages:w,selectedConversation:s,allowedRecipients:H,setAllowedRecipients:A})=>{var _,P,B;const[b,v]=d.useState(""),[I,F]=d.useState(null),[S,y]=d.useState(null),[x,L]=d.useState(null),[E,D]=d.useState(!1),R=d.useRef(null),M=d.useRef(null),U=d.useRef({});d.useEffect(()=>{const a=async()=>{try{const i=await j.getAllowedRecipients();A(i.data),i.data.length===1&&F(i.data[0])}catch{N.error("Failed to load recipients")}};r&&r.id&&a()},[r]),d.useEffect(()=>{const a=async()=>{var i,u;if(!(!(r!=null&&r.id)||!s)){D(!0);try{let o;if(s.type==="conversation"?o=s.conversationHash:o=s.id,!o)throw new Error("Invalid recipient ID");const f=await j.getMessages(o);w(f.data),F(s.type==="recipient"?s.recipient:H.find(h=>h.id===o)||null)}catch(o){N.error(((u=(i=o.response)==null?void 0:i.data)==null?void 0:u.message)||"Failed to load messages")}finally{D(!1)}}};if(r!=null&&r.id&&s){a();const i=o=>{const f=s.type==="conversation"?s.conversationHash.split("_").find(h=>h!==r.id):s.id;(o.senderId===r.id&&o.recipientId===f||o.recipientId===r.id&&o.senderId===f)&&w(h=>h.some(q=>q.id===o.id)?h:[...h,o])},u=o=>{w(f=>f.map(h=>h.id===o.messageId?{...h,readAt:o.readAt}:h))};return k.onNewMessage(i),k.onMessageRead(u),()=>{k.onNewMessage(null),k.onMessageRead(null)}}},[r,s]),d.useEffect(()=>{var i;if(g.length===0)return;const a=g.filter(u=>u.recipientId===r.id&&!u.readAt);if(a.length>0){const u=a[0],o=U.current[u.id];o&&o.scrollIntoView({behavior:"smooth",block:"start"})}else(i=R.current)==null||i.scrollIntoView({behavior:"smooth"})},[g,r.id]);const t=async a=>{if(a.preventDefault(),(s==null?void 0:s.type)==="conversation"&&(s!=null&&s.conversationHash.includes("_")))return N.info("You can not send messages.");if(!(!I||!b.trim()&&!x))try{let i={};x&&(i=await j.uploadFile(x));const u={recipientId:I.id,content:b,type:x?i.mimeType.split("/")[0]:"text",fileUrl:x?i.fileUrl:null,fileName:x?i.fileName:null,fileSize:x?i.fileSize:null,mimeType:x?i.mimeType:null,replyToId:(S==null?void 0:S.id)||null},o=await j.sendMessage(u);w(f=>f.some(h=>h.id===o.data.id)?f:[...f,o.data]),v(""),L(null),y(null),M.current.value=null}catch{N.error("Failed to send message")}},l=async a=>{try{await j.markMessageAsRead(a)}catch{N.error("Failed to mark message as read")}},c=a=>{if((s==null?void 0:s.type)==="conversation"){const i=s==null?void 0:s.conversationHash.split("_");return i[0]==a.senderId||i[1]==a.recipientId?!0:r.role==="super_admin"?a.sender.role==="student":a.senderId!==r.id}return a.senderId!==r.id},n=a=>new Date(a).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}),p=a=>e.jsxs("div",{className:"flex flex-col gap-2",children:[a.type==="image"&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:T(a.fileUrl),alt:a.fileName,className:"max-w-full h-auto rounded-xl shadow-sm",style:{maxHeight:"200px"}}),e.jsxs("a",{href:T(a.fileUrl),download:a.fileName,className:"text-gray-200 hover:text-gray-300 underline flex items-center gap-1 text-sm transition-colors",children:[e.jsx($,{className:"w-4 h-4"}),"Download ",a.fileName," (",(a.fileSize/1024).toFixed(2)," KB)"]})]}),a.type==="file"&&e.jsxs(e.Fragment,{children:[e.jsxs("a",{href:T(a.fileUrl),download:a.fileName,className:"text-blue-600 hover:text-blue-700 underline flex items-center gap-1 transition-colors",children:[e.jsx($,{className:"w-4 h-4"}),a.fileName," (",(a.fileSize/1024).toFixed(2)," KB)"]}),e.jsxs("a",{href:T(a.fileUrl),download:a.fileName,className:"text-blue-600 hover:text-blue-700 underline flex items-center gap-1 text-sm transition-colors",children:[e.jsx($,{className:"w-4 h-4"}),"Download ",a.fileName]})]}),a.type==="text"&&e.jsx("p",{className:"leading-relaxed",children:a.content})]}),m=a=>{var u,o,f;if(!a.replyToId)return null;const i=g.find(h=>h.id===a.replyToId);return i?e.jsx("div",{className:"bg-black/5 backdrop-blur-sm p-3 rounded-lg mb-3 border-l-4 border-blue-500 cursor-pointer hover:bg-black/10 transition-colors",onClick:()=>{const h=U.current[a.replyToId];h&&h.scrollIntoView({behavior:"smooth",block:"center"})},children:e.jsxs("p",{className:"text-sm text-gray-600",children:["Replying to ",(u=i.sender)==null?void 0:u.name,":"," ",((o=i.content)==null?void 0:o.length)>30?((f=i.content)==null?void 0:f.slice(0,27))+"...":i.content]})}):null},z=()=>e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3 text-gray-500",children:[e.jsx(O,{className:"w-8 h-8 animate-spin"}),e.jsx("p",{className:"text-sm",children:"Loading messages..."})]})});return e.jsxs("div",{className:"flex-1 flex flex-col bg-gradient-to-br from-slate-50 to-gray-100 shadow-2xl rounded-r-2xl border border-gray-200/50",children:[e.jsxs("div",{className:"px-6 py-4 bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 text-white flex items-center gap-3 rounded-tr-2xl",children:[e.jsx("div",{className:"w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm",children:e.jsx(V,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:s?s==null?void 0:s.displayName:"Select a conversation"}),e.jsx("p",{className:"text-sm text-white/80",children:s?`${((_=s==null?void 0:s.recipient)==null?void 0:_.role)||"-"}`:"Choose someone to chat with"})]})]}),E?e.jsx(z,{}):e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4 bg-gradient-to-b from-transparent to-white/50",children:[g.map(a=>{var i;return e.jsx("div",{ref:u=>U.current[a.id]=u,className:`flex ${c(a)?"justify-start":"justify-end"}`,onClick:()=>a.recipientId===r.id&&!a.readAt&&l(a.id),children:e.jsxs("div",{className:`group relative max-w-[70%] ${c(a)?"bg-white shadow-md border border-gray-200/50":"bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg"} rounded-2xl p-4 transition-all duration-200 hover:shadow-lg`,children:[m(a),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"flex-1",children:[(s==null?void 0:s.type)==="conversation"&&e.jsx("p",{className:`font-medium text-sm mb-1 ${c(a)?"text-gray-600":"text-white/90"}`,children:(i=a.sender)==null?void 0:i.name}),e.jsx("div",{className:`${c(a)?"text-gray-800":"text-white"}`,children:p(a)}),e.jsx("p",{className:`text-xs mt-2 flex items-center gap-1 ${c(a)?"text-gray-500":"text-white/70"}`,children:n(a.createdAt)})]}),["student","consultant"].includes(r.role)&&e.jsx("div",{className:"absolute -right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("button",{onClick:()=>{y(a),v("")},className:"p-2 bg-white shadow-lg rounded-full hover:shadow-xl transition-all duration-200 text-gray-600 hover:text-blue-600",title:"Reply",children:e.jsx(Z,{className:"w-4 h-4"})})})]})]})},a.id)}),e.jsx("div",{ref:R})]}),(s==null?void 0:s.type)==="conversation"&&((P=s==null?void 0:s.conversationHash)!=null&&P.includes("_"))?null:s?["manager","consultant","super_admin"].includes(r.role)&&e.jsx("div",{className:"p-6 border-t border-gray-200/50 bg-white/80 backdrop-blur-sm rounded-br-2xl",children:e.jsxs("form",{onSubmit:t,className:"flex flex-col gap-4",children:[S&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 p-3 rounded-xl flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1 h-8 bg-blue-500 rounded-full"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-blue-800",children:["Replying to ",(B=S.sender)==null?void 0:B.name]}),e.jsx("p",{className:"text-sm text-blue-600 truncate max-w-md",children:S.content})]})]}),e.jsx("button",{onClick:()=>y(null),className:"text-blue-500 hover:text-blue-700 font-medium text-sm px-3 py-1 rounded-lg hover:bg-blue-100 transition-colors",children:"Cancel"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("input",{type:"text",value:b,onChange:a=>v(a.target.value),placeholder:"Type your message...",className:"flex-1 px-4 py-3 border border-gray-300 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 shadow-sm"}),e.jsx("input",{type:"file",ref:M,onChange:a=>L(a.target.files[0]),accept:"image/*,.pdf,.doc,.docx",className:"hidden"}),e.jsx("button",{type:"button",onClick:()=>M.current.click(),className:"p-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl transition-all duration-200 shadow-sm hover:shadow-md",children:e.jsx($,{className:"w-5 h-5"})}),e.jsx("button",{type:"submit",className:"px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed",disabled:!I||!b.trim()&&!x,children:e.jsx(G,{className:"w-5 h-5"})})]}),x&&e.jsx("div",{className:"bg-amber-50 border border-amber-200 p-3 rounded-xl",children:e.jsxs("p",{className:"text-sm text-amber-800",children:[e.jsx("strong",{children:"Selected file:"})," ",x.name," (",(x.size/1024).toFixed(2)," KB)"]})})]})}):null]})},ce=()=>{const{user:r}=Y(),[g,w]=d.useState([]),[s,H]=d.useState(null),[A,b]=d.useState([]),[v,I]=d.useState([]);return e.jsxs("div",{className:"flex h-[calc(100vh-4rem)] bg-gradient-to-br from-blue-50 to-purple-50",children:[e.jsx(C,{user:r,conversations:g,setConversations:w,selectedConversation:s,setSelectedConversation:H,setMessages:b,allowedRecipients:v,setAllowedRecipients:I}),e.jsx(ee,{user:r,messages:A,setMessages:b,selectedConversation:s,allowedRecipients:v,setAllowedRecipients:I})]})};export{ce as default};
